{% extends 'donor/donor_base.html' %}

{% block content %}
<div class="container py-5">
    <h2 class="text-center text-danger mb-4">Available Blood Requests</h2>

    {% if available_requests %}
        <div class="row gy-4">
            {% for request in available_requests %}
            <div class="col-md-6">
                <div class="card border-danger shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title text-danger">Blood Group: {{ request.blood_group }}</h5>
                        <p class="card-text mb-1">üìç <strong>Location:</strong> {{ request.location }}</p>
                        <p class="card-text"><small class="text-muted">üïí Created At: {{ request.created_at }}</small></p>

                        <form method="POST" action="{% url 'donor_response' request.id %}" class="d-flex gap-2 mt-3">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="accept">
                            <input type="hidden" name="weight">
                            <input type="hidden" name="height">
                            <button type="button" class="btn btn-success" onclick="openModal(this)">
                                Accept
                            </button>
                            <button type="submit" name="action" value="reject" class="btn btn-danger">
                                Reject
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <p class="text-center text-muted mt-5">No available requests at the moment.</p>
    {% endif %}
</div>

<!-- Bootstrap Modal -->
<div class="modal fade" id="bmiModal" tabindex="-1" aria-labelledby="bmiModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-light">
        <h5 class="modal-title" id="bmiModalLabel">Enter Your Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="clearModalInputs()"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="modalWeight" class="form-label">Weight (kg)</label>
          <input type="number" class="form-control" id="modalWeight" min="1" step="0.1">
        </div>
        <div class="mb-3">
          <label for="modalHeight" class="form-label">Height (feet)</label>
          <input type="number" class="form-control" id="modalHeight" min="1" step="0.1">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="clearModalInputs()">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="submitModal()">Submit</button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const modalElement = new bootstrap.Modal(document.getElementById('bmiModal'));
    let currentForm = null;

    // Expose functions globally so inline onclick can call them
    window.openModal = function(button) {
        currentForm = button.closest('form');
        modalElement.show();
    };

    window.clearModalInputs = function() {
        document.getElementById('modalWeight').value = '';
        document.getElementById('modalHeight').value = '';
    };

    window.submitModal = function() {
        const weight = document.getElementById("modalWeight").value;
        const height = document.getElementById("modalHeight").value;

        if (!weight || !height) {
            alert("Please enter both weight and height.");
            return;
        }

        currentForm.querySelector('input[name="weight"]').value = weight;
        currentForm.querySelector('input[name="height"]').value = height;

        modalElement.hide();
        currentForm.submit();
    };
  });
</script>
{% endblock %}

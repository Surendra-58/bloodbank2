{% extends 'hospital/hospital_base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow-sm border-0 rounded-4 p-4">
        <h2 class="mb-3 text-center fw-bold">Hospital Dashboard</h2>
        <p class="text-center text-muted mb-4">Welcome! From here, you can request blood or track your existing requests.</p>
        
        <div class="row g-4 justify-content-center">
            <div class="col-md-6 col-lg-4">
                <a href="{% url 'hospital_request_blood' %}" class="btn btn-outline-danger w-100 py-3 rounded-3 shadow-sm fw-semibold">
                    <i class="fas fa-hand-holding-droplet me-2"></i> Request Blood
                </a>
            </div>
            <div class="col-md-6 col-lg-4">
                <a href="{% url 'hospital_view_requests' %}" class="btn btn-outline-primary w-100 py-3 rounded-3 shadow-sm fw-semibold">
                    <i class="fas fa-clipboard-list me-2"></i> View Blood Requests
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    <!-- Colored Marker Icons -->
    <script>
        const adminLat = {{ admin_lat|default:27.7172 }};
        const adminLng = {{ admin_lng|default:85.3240 }};

        const map = L.map('map').setView([adminLat, adminLng], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // Define custom icons
        const redIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
            shadowUrl: 'https://unpkg.com/leaflet@1.9.3/dist/images/marker-shadow.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
        });

        const blueIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
            shadowUrl: 'https://unpkg.com/leaflet@1.9.3/dist/images/marker-shadow.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
        });

        const greenIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
            shadowUrl: 'https://unpkg.com/leaflet@1.9.3/dist/images/marker-shadow.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
        });

        // Marker cluster group
        const markers = L.markerClusterGroup();

        const users = [
            {% for user in users %}
            {
                name: "{{ user.first_name }} {{ user.last_name }} ({{ user.get_user_type_display }})",
                lat: {{ user.latitude }},
                lng: {{ user.longitude }},
                user_type: "{{ user.user_type }}"
            },
            {% endfor %}
        ];

        users.forEach(user => {
            let icon = blueIcon;  // default

            if (user.user_type === "1") icon = redIcon;      // Admin
            else if (user.user_type === "2") icon = greenIcon; // Hospital

            const marker = L.marker([user.lat, user.lng], { icon: icon })
                            .bindPopup(user.name);
            markers.addLayer(marker);
        });

        map.addLayer(markers);
    </script>

{% endblock %}
